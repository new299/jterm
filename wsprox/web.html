<html>
<head>
<meta charset="UTF-8" />

<script src="emsocket.js"></script>
<script src="webssh2.js"></script>

<script>

  var c=0;

  function webssh_phase2() {
    Module.ccall('webssh2_fingerprint','number',[],[]);
    c=0;
    queue_authcheck();
  }
  
  function queue_connect() {
    setTimeout(function() {
      result = Module.ccall('webssh2_connect','number',[],[]);
      if(result != 0) { 
          if(jss_closed() != true) queue_connect(); 
          console.debug("connect failed ret: " + result);
        } else {
          console.debug("connect completed successfully ret: " + result);
          if(jss_closed() != true) queue_handshake();
        }
    }, 1000);
  }

  function queue_handshake() {
    setTimeout(function() {
      result = Module.ccall('webssh2_handshake','number',[],[]);
      if(result != 0) { 
          console.debug("handshake failed ret: " + result);
          if(jss_closed() != true) {
             if(c < 10) {
               queue_handshake();
               c=c+1;
             }
          }
        } else {
          console.debug("handshake completed successfully ret: " + result);
          if(jss_closed() != true) webssh_phase2();
        }
    }, 500);
  }

  function queue_authcheck() {
    setTimeout(function() {
      result = Module.ccall('webssh2_authcheck','number',[],[]);
      if(result == 0) { 
        console.debug("authcheck failed: " + result);
        if(c < 10) {
          if(jss_closed() != true) queue_authcheck();
          c=c+1;
        }
      } else {
        c=0;
        console.debug("authcheck completed successfully");
        queue_authenticate();
      }
    }, 500);
  }
  
  function queue_authenticate() {
    setTimeout(function() {
      result = Module.ccall('webssh2_authenticate','number',[],[]);
      if(result == 0) { 
        console.debug("authenatication failed: " + result);
        if(c < 10) {
          if(jss_closed() != true) queue_authenticate();
          c=c+1;
        }
      } else {
        c=0;
        console.debug("authentication completed successfully");
        queue_requestshell();
      }
    }, 500);
  }

  function queue_requestshell() {
    setTimeout(function() {
      result = Module.ccall('webssh2_requestshell','number',[],[]);
      if(result == 0) { 
        console.debug("requestshell failed: " + result);
        if(c < 10) {
          if(jss_closed() != true) queue_requestshell();
          c=c+1;
        }
      } else {
        c=0;
        console.debug("requestshell completed successfully");
        queue_setenv();
      }
    }, 500);
  }

  function queue_setenv() {
    setTimeout(function() {
      result = Module.ccall('webssh2_setenv','number',[],[]);
      if(result == 0) { 
        console.debug("setenv failed: " + result);
        if(c < 10) {
          if(jss_closed() != true) queue_setenv();
          c=c+1;
        }
      } else {
        c=0;
        console.debug("setenv completed successfully");
        queue_setterm();
      }
    }, 500);
  }
  
  function queue_setterm() {
    setTimeout(function() {
      result = Module.ccall('webssh2_setterm','number',[],[]);
      if(result == 0) { 
        console.debug("setterm failed: " + result);
        if(c < 10) {
          if(jss_closed() != true) queue_setterm();
          c=c+1;
        }
      } else {
        c=0;
        console.debug("setterm completed successfully");
        queue_getshell();
      }
    }, 500);
  }
  
  function queue_getshell() {
    setTimeout(function() {
      result = Module.ccall('webssh2_getshell','number',[],[]);
      if(result == 0) { 
        console.debug("getshell failed: " + result);
        if(c < 10) {
          if(jss_closed() != true) queue_getshell();
          c=c+1;
        }
      } else {
        c=0;
        console.debug("getshell completed successfully");
        queue_read();
      }
    }, 500);
  }

  function on_recv() {
    var buffer = Module._malloc(1024);
    var len = Module.ccall('webssh2_read','number',['number','number'],[buffer,1024]);
   
    if(len > 0) {   
      // Convert the resulting string to a JS string
      
      setValue(buffer+len,0,'i8');
      var buffer_str = Pointer_stringify(buffer);
      document.getElementById('comms').innerHTML += "Received " + len + " : " + buffer_str + "<br>";
    }
  }

  function queue_read() {
    jss_recv_cb(on_recv);
    setTimeout(function() {
      on_recv();
      queue_read();
    }, 500);
  }

  jss_recv_cb(function() {});


  function do_connect() {
    var username = document.getElementById('username').value;
    var password = document.getElementById('password').value;

    var usernameptr = Module._malloc(username.length+1);
    Module.writeAsciiToMemory(username, usernameptr);

    var passwordptr = Module._malloc(password.length+1);
    Module.writeAsciiToMemory(password, passwordptr);
    result = Module.ccall('webssh2_setuserpass','number',['number','number'],[usernameptr,passwordptr]);
    queue_connect();
  }

  window.onbeforeunload = function() {
    jss_close();
  };

  function ssh_send(data) {
    var mystring = data + "\r\n";
    var strptr = Module._malloc(mystring.length+1);
    Module.writeAsciiToMemory(mystring, strptr);
    setValue(strptr+mystring.length+1,0,'i8');
  
    result = Module.ccall('webssh2_write','number',['number','number'],[strptr,mystring.length]);
  }

  function senddata() {
    var data = document.getElementById('sendtext').value;
    ssh_send(data);
    document.getElementById('comms').innerHTML += "Sent: " + data + "<br>";
  }

</script>

</head>
<body>
  Send: <input id="sendtext" type="text" />
  <input type="button" id="sendBtn" value="send" onclick="senddata()"></input>
  Username: <input id="username" type="text" /><br>
  Password: <input id="password" type="text" /><br>
  <input type="button" id="connectBtn" value="connect" onclick="do_connect()"></input>

  <div id='comms'></div>

</body>
</html>
