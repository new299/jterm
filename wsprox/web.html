<html>
<head>
<meta charset="UTF-8" />

<script src="emsocket.js"></script>
<script src="webssh2.js"></script>
<script src="webssh2_interface.js"></script>
<script src="textmatrix.js"></script>

<script>
  

  function do_connect() {
    var username = document.getElementById('username').value;
    var password = document.getElementById('password').value;

    var usernameptr = Module._malloc(username.length+1);
    Module.writeAsciiToMemory(username, usernameptr);

    var passwordptr = Module._malloc(password.length+1);
    Module.writeAsciiToMemory(password, passwordptr);
    result = Module.ccall('webssh2_setuserpass','number',['number','number'],[usernameptr,passwordptr]);
    queue_connect(on_recv);
    add_textmatrix(80,80);
    textmatrix_setpos(40,40,' ');
    textmatrix_setpos(20,20,'C');
  }

  window.onbeforeunload = function() {
    jss_close();
  };

  function senddata() {
    var data = document.getElementById('sendtext').value;
    ssh_send(data);
    document.getElementById('comms').innerHTML += "Sent: " + data + "<br>";
  }
  
  function on_recv() {
    var buffer = Module._malloc(1024);
    var len = Module.ccall('webssh2_read','number',['number','number'],[buffer,1024]);
    if(len > 0) {
      // Convert the resulting string to a JS string
      setValue(buffer+len,0,'i8');
      var buffer_str = Pointer_stringify(buffer);
      document.getElementById('comms').innerHTML += "Received " + len + " : " + buffer_str + "<br>";
    }
  }


</script>

</head>
<body>
  Username: <input id="username" type="text" /><br>
  Password: <input id="password" type="text" /><br>
  <input type="button" id="connectBtn" value="connect" onclick="do_connect()"></input><br><br>
  Send: <input id="sendtext" type="text" />
  <input type="button" id="sendBtn" value="send" onclick="senddata()"></input><br>

  <div id='comms'></div>
  <div style="display: inline" id='tml'></div>

</body>
</html>
