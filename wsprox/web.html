<html>
<head>
<meta charset="UTF-8" />

<script src="emsocket.js"></script>
<script src="webssh2.js"></script>
<script src="webssh2_interface.js"></script>
<script src="textmatrix.js"></script>

<script>
  
  function getChar(event) {

    console.debug("kcode: " + event.keyCode);
    console.debug("ctrl: " + event.ctrlKey);

    var kcode = event.keyCode;

    if(event.keyCode == 13) return "\n";
    if(event.keyCode == 8 ) return String.fromCharCode(127);

    if(event.keyCode == 37) return String.fromCharCode(0x1b) + 'O' + 'D';
    if(event.keyCode == 39) return String.fromCharCode(0x1b) + 'O' + 'C';
    if(event.keyCode == 38) return String.fromCharCode(0x1b) + 'O' + 'A';
    if(event.keyCode == 40) return String.fromCharCode(0x1b) + 'O' + 'B';

    if (event.which == null) {
      if(event.ctrlKey) {
        if(kcode>=97) kcode = kcode-97+65;
        kcode-=64;
      }
      return String.fromCharCode(kcode) // IE
    } else if (event.which!=0 && event.charCode!=0) {
      kcode = event.which;

      if(event.ctrlKey) {
        if(kcode>=97) kcode = kcode-97+65;
        kcode-=64;
      }
      return String.fromCharCode(kcode)   // the rest

    } else {
      return null // special key
    }
  }

  function do_connect() {
    var username = document.getElementById('username').value;
    var password = document.getElementById('password').value;

    var usernameptr = Module._malloc(username.length+1);
    Module.writeAsciiToMemory(username, usernameptr);

    var passwordptr = Module._malloc(password.length+1);
    Module.writeAsciiToMemory(password, passwordptr);
    result = Module.ccall('webssh2_setuserpass','number',['number','number'],[usernameptr,passwordptr]);
    queue_connect(on_recv);

    Module.ccall('webvterm_init',null,['number','number'],[80,23]);

    add_textmatrix(80,23);
    textmatrix_setpos(40,20,' ');
    textmatrix_setpos(20,20,'C');
    document.getElementById('sendtext').onkeypress = function(event) {
      var char = getChar(event || window.event)
      if (!char) return // special key
      ssh_send(char);
      return false
    }
  }

  window.onbeforeunload = function() {
    jss_close();
  };

  function senddata() {
    var data = document.getElementById('sendtext').value;
    ssh_send(data);
    document.getElementById('comms').innerHTML += "Sent: " + data + "<br>";
  }

  function redraw() {
    var bufferptr = Module._malloc(1024);
    for(var cy=0;cy<23;cy++) {
      Module.ccall('webvterm_get_row',null,['number','number','number'],[cy,bufferptr,1024]);
      var buffer_str = Pointer_stringify(bufferptr);
      
      var current_line = textmatrix_getline(cy);
      if(buffer_str != current_line) {

        //console.debug("vterm buffer str " + buffer_str.length + ": " + buffer_str);
//        for(var cx=0;cx<80;cx++) {
//          textmatrix_setpos(cx,cy,buffer_str.substr(cx,1));
//        }
        textmatrix_setline(cy,buffer_str);
      }
    }
  }
  
    

  var buffer = Module._malloc(1024);
  function on_recv() {
    var len = Module.ccall('webssh2_read','number',['number','number'],[buffer,1024]);
    if(len > 0) {

      Module.ccall('webvterm_recv',null,['number','number'],[buffer,len]);
      redraw();

      // Convert the resulting string to a JS string
//      setValue(buffer+len,0,'i8');
//      var buffer_str = Pointer_stringify(buffer);
//      document.getElementById('comms').innerHTML += "Received " + len + " : " + buffer_str + "<br>";
    }
  }


</script>

</head>
<body>
  Username: <input id="username" type="text" /><br>
  Password: <input id="password" type="text" /><br>
  <input type="button" id="connectBtn" value="connect" onclick="do_connect()"></input><br><br>
  Send: <input id='sendtext' type="text" />

  <div id='comms'></div>
  <div style="display: inline" id='tml'></div>

</body>
</html>
