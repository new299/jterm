<html>
<head>
<meta charset="UTF-8" />

<script src="emsocket.js"></script>
<script src="webssh2.js"></script>
<script src="webssh2_interface.js"></script>
<script src="textmatrix.js"></script>


<script>

  // Globals are emscripten doesn't do memory management?
  var textbufferptr = Module._malloc(256);
  var fgbufferptr   = Module._malloc(256*4);
  var bgbufferptr   = Module._malloc(256*4);
  var revbufferptr  = Module._malloc(256*4);
  var buffer        = Module._malloc(1024);

  var hozmargin=2;
  var lowermargin=60;

  function char_carray_to_array(bufptr,len) {
    var array = [];
 
    for(i=0;i<len;i++) {
      var value = String.fromCharCode(Module.getValue(bufptr+i,'i8'));
      array.push(value);
    }
 
    return array;
  }

  function webvterm_damage_cb(start_row,end_row,start_col,end_col) {
    Module.ccall('webvterm_cursor_position_update',null,[],[]);
    var cursor_x = Module.ccall('webvterm_cursor_position_x','number',[],[]);
    var cursor_y = Module.ccall('webvterm_cursor_position_y','number',[],[]);
    textmatrix_draw_cursor(cursor_x,cursor_y);

    var rows = textmatrix_get_rows();
    var cols = textmatrix_get_cols();

    for(var cy=start_row;cy<end_row;cy++) {
      Module.ccall('webvterm_get_row',null,['number','number','number','number','number'],[cy,textbufferptr,bgbufferptr,fgbufferptr,revbufferptr,256]);
      var buffer_str = Pointer_stringify(textbufferptr);
      
      var textbuffer = char_carray_to_array(textbufferptr,cols);
      var bgbuffer   = uint_carray_to_array(bgbufferptr,cols);
      var fgbuffer   = uint_carray_to_array(fgbufferptr,cols);
      var revbuffer  = uint_carray_to_array(revbufferptr,cols);

      var current_line = textmatrix_getline_txt(cy);
      if(buffer_str != current_line) {

        for(var cx=0;cx<cols;cx++) {
          textmatrix_setpos(cx,cy,textbuffer[cx],bgbuffer[cx],fgbuffer[cx],revbuffer[cx]);
        }
        textmatrix_redraw_line(cy);
      }
    }
  }
    

  function uint_carray_to_array(bufptr,len) {
    var array = [];
 
    for(i=0;i<len;i++) {
      var value = Module.getValue(bufptr+(i*4),'i32');
      array.push(value);
    }
 
    return array;
  }
  
  function getChar(event) {
    var TABKEY = 9;
    if(event.keyCode == TABKEY) {
      if(event.preventDefault) {
        event.preventDefault();
      }
      return "\t";
   }


    var kcode = event.keyCode;

    if(event.keyCode == 13) return String.fromCharCode(13);
    if(event.keyCode == 27) return String.fromCharCode(27);
    if(event.keyCode == 8 ) return String.fromCharCode(127);

    if(event.keyCode == 37) return String.fromCharCode(0x1b) + 'O' + 'D';
    if(event.keyCode == 39) return String.fromCharCode(0x1b) + 'O' + 'C';
    if(event.keyCode == 38) return String.fromCharCode(0x1b) + 'O' + 'A';
    if(event.keyCode == 40) return String.fromCharCode(0x1b) + 'O' + 'B';

    if (event.which == null) {
      if(event.ctrlKey) {
        if(kcode>=97) kcode = kcode-97+65;
        kcode-=64;
      }
      return String.fromCharCode(kcode) // IE
    } else if (event.which!=0 && event.charCode!=0) {
      kcode = event.which;

      if(event.ctrlKey) {
        if(kcode>=97) kcode = kcode-97+65;
        kcode-=64;
      }
      return String.fromCharCode(kcode)   // the rest

    } else {
      return null // special key
    }
  }

  function detect_disconnect() {
    var c = Module.ccall('webssh2_channel_closed','number',[],[]);
    if(c != 0) { 
      disconnected();
    } else {
      setTimeout(detect_disconnect,2000);
    }
  }

  function do_connect() {
    // add display
    textmatrix_add_px(window.innerWidth-hozmargin,window.innerHeight-lowermargin);
    document.body.style.background = "#000000";
    var rows = textmatrix_get_rows();
    var cols = textmatrix_get_cols();

    Module.ccall('webvterm_init',null,['number','number'],[cols,rows]);

    document.getElementById('logindisplay').style.display = 'none';
    var serverad = document.getElementById('serverad').value;
    var port     = document.getElementById('port'    ).value;
    var username = document.getElementById('username').value;
    var password = document.getElementById('password').value;

    jss_set_server_address(serverad + ":" + port);
    var usernameptr = Module._malloc(username.length+1);
    Module.writeAsciiToMemory(username, usernameptr);

    var passwordptr = Module._malloc(password.length+1);
    Module.writeAsciiToMemory(password, passwordptr);
    result = Module.ccall('webssh2_setuserpass','number',['number','number'],[usernameptr,passwordptr]);
    queue_connect(on_recv);

    document.onkeypress = function(event) {
      var char = getChar(event || window.event)
      if (!char) return // special key
      ssh_send(char);
      return false
    }

  }

  window.onbeforeunload = function() {
    jss_close();
  };

  window.onresize = function(event) { doresize(); }


  function doresize() {
    textmatrix_resize_px(window.innerWidth-hozmargin,window.innerHeight-lowermargin);
    var rows = textmatrix_get_rows();
    var cols = textmatrix_get_cols();
    Module.ccall('webssh2_resize' ,null,['number','number'],[cols,rows]);
    Module.ccall('webvterm_resize',null,['number','number'],[cols,rows]);
    webvterm_damage_cb(0,rows,0,cols);
  };

  function display_fingerprint() {
    fingerprintstrptr = Module.ccall('webssh2_get_fingerprint','number',[],[]);
    var fingerprintstr = Pointer_stringify(fingerprintstrptr);
    var f = document.getElementById('fingerprint');
    f.innerHTML = fingerprintstr;
  }

  var firstrecv=1;
  function on_recv() {
    var len=1;

    for(;len > 0;) {
      len = Module.ccall('webssh2_read','number',['number','number'],[buffer,1024]);
      if(len > 0) {
        Module.ccall('webvterm_recv',null,['number','number'],[buffer,len]);
      }
    }


    if(firstrecv==1) {
      doresize();
      firstrecv=0;
      detect_disconnect();
      display_fingerprint();
      setTimeout(function() {doresize(); },500); // for some reason the first resize often fails, and we're stuck at 80 cols
    }
    Module.ccall('webvterm_flush_damage',null,[],[]);
  }

  function connect_fail(err) {
    alert("Unable to Connect:" + err);
    location.reload();
  }

  function disconnected() {
    alert("Disconnected");
    location.reload();
  }

  function processpaste (e, t) {
    if(e.preventDefault) {
      e.stopPropagation();
      e.preventDefault();
    }

    if (e && e.clipboardData && e.clipboardData.getData) {
      ssh_send(e.clipboardData.getData('text/plain'));
      console.debug("pastetext: " + e.clipboardData.getData('text/plain'));
      return false;
    }

    // following not required.
    // redraw everything
    setTimeout(function() {
      var rows = textmatrix_get_rows();
      var cols = textmatrix_get_cols();
      webvterm_damage_cb(0,rows,0,cols);
    },50); 

    return false;
  }

</script>


<!--Pulling Awesome Font -->
<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css" rel="stylesheet">
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
<link href="login.css" rel="stylesheet">
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>

<body style="background-color: #b0c4de;">

<div class="container" id="logindisplay">
    <div class="row">
        <div class="col-md-offset-5 col-md-3">
            <div class="form-login">
            <h4>Connect</h4>
            <div class="row">
              <div class="col-md-8">
                <input type="text" id="serverad" class="form-control input-sm chat-input" placeholder="server" tabindex=1 />
              </div>
              <div class="col-md-4 col-md-offset-0">
                <input type="text" id="port" class="form-control input-sm chat-input" placeholder="22" value="22" />
              </div>
            </div>
            </br>
            <input type="text" id="username" class="form-control input-sm chat-input" placeholder="username" tabindex=2 />
            <input type="password" id="password" class="form-control input-sm chat-input" placeholder="password" tabindex=3 onkeydown="if (event.keyCode == 13) do_connect();" />
            </br>
            <div class="wrapper">
            <span class="group-btn">     
                <a href="#" onclick="do_connect()" class="btn btn-primary btn-md">login <i class="fa fa-sign-in"></i></a>
            </span>
            </div>
            </div>
        
        </div>
    </div>
</div>
<div width=100%>
<div style="font-family: monospace; white-space: pre; margin: 0 auto;" id='tml'></div>
</div>

<div id='ad' style="height:60px">
  <div id='fingerprint' style="font-family: monospace; color:white; font-size:8px"></div>
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- jterm -->
  <ins class="adsbygoogle" style="display:inline-block;width:468px;height:60px" data-ad-client="ca-pub-9449433064496325" data-ad-slot="3977486817"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>

</body>
</html>
