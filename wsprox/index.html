<html>
<head>
<meta charset="UTF-8" />

<script src="emsocket.js"></script>
<script src="webssh2.js"></script>
<script src="webssh2_interface.js"></script>
<script src="textmatrix.js"></script>


<script>

  // Globals are emscripten doesn't do memory management?
  var textbufferptr = Module._malloc(128);
  var fgbufferptr   = Module._malloc(128*4);
  var bgbufferptr   = Module._malloc(128*4);

  function char_carray_to_array(bufptr,len) {
    var array = [];
 
    for(i=0;i<len;i++) {
      var value = String.fromCharCode(Module.getValue(bufptr+i,'i8'));
      array.push(value);
    }
 
    return array;
  }

  function uint_carray_to_array(bufptr,len) {
    var array = [];
 
    for(i=0;i<len;i++) {
      var value = Module.getValue(bufptr+(i*4),'i32');
      array.push(value);
    }
 
    return array;
  }
  
  function getChar(event) {
    var TABKEY = 9;
    if(event.keyCode == TABKEY) {
      if(event.preventDefault) {
        event.preventDefault();
      }
      return "\t";
   }

   console.debug("kcode: " + event.keyCode);
   console.debug("ctrl: " + event.ctrlKey);

    var kcode = event.keyCode;

    if(event.keyCode == 13) return "\n";
    if(event.keyCode == 27) return String.fromCharCode(27);
    if(event.keyCode == 8 ) return String.fromCharCode(127);

    if(event.keyCode == 37) return String.fromCharCode(0x1b) + 'O' + 'D';
    if(event.keyCode == 39) return String.fromCharCode(0x1b) + 'O' + 'C';
    if(event.keyCode == 38) return String.fromCharCode(0x1b) + 'O' + 'A';
    if(event.keyCode == 40) return String.fromCharCode(0x1b) + 'O' + 'B';

    if (event.which == null) {
      if(event.ctrlKey) {
        if(kcode>=97) kcode = kcode-97+65;
        kcode-=64;
      }
      return String.fromCharCode(kcode) // IE
    } else if (event.which!=0 && event.charCode!=0) {
      kcode = event.which;

      if(event.ctrlKey) {
        if(kcode>=97) kcode = kcode-97+65;
        kcode-=64;
      }
      return String.fromCharCode(kcode)   // the rest

    } else {
      return null // special key
    }
  }

  function do_connect() {
    // add display
    add_textmatrix(80,23);
    textmatrix_setpos(40,20,' ');
    textmatrix_setpos(20,20,'C');
    Module.ccall('webvterm_init',null,['number','number'],[80,23]);

    document.getElementById('logindisplay').style.display = 'none';
    var serverad = document.getElementById('serverad').value;
    var port     = document.getElementById('port'    ).value;
    var username = document.getElementById('username').value;
    var password = document.getElementById('password').value;

    jss_set_server_address(serverad + ":" + port);
    console.debug("addr: " + serverad + ":" + port);
    var usernameptr = Module._malloc(username.length+1);
    Module.writeAsciiToMemory(username, usernameptr);

    var passwordptr = Module._malloc(password.length+1);
    Module.writeAsciiToMemory(password, passwordptr);
    result = Module.ccall('webssh2_setuserpass','number',['number','number'],[usernameptr,passwordptr]);
    queue_connect(on_recv);

    document.onkeypress = function(event) {
      var char = getChar(event || window.event)
      if (!char) return // special key
      ssh_send(char);
      return false
    }
  }

  window.onbeforeunload = function() {
    jss_close();
  };

  function senddata() {
    var data = document.getElementById('sendtext').value;
    ssh_send(data);
    document.getElementById('comms').innerHTML += "Sent: " + data + "<br>";
  }

  function redraw() {

    Module.ccall('webvterm_cursor_position_update',null,[],[]);
    var cursor_x = Module.ccall('webvterm_cursor_position_x','number',[],[]);
    var cursor_y = Module.ccall('webvterm_cursor_position_y','number',[],[]);

    textmatrix_draw_cursor(cursor_x,cursor_y);

    for(var cy=0;cy<23;cy++) {
      Module.ccall('webvterm_get_row',null,['number','number','number','number','number'],[cy,textbufferptr,bgbufferptr,fgbufferptr,128]);
      var buffer_str = Pointer_stringify(textbufferptr);
      
      var textbuffer = char_carray_to_array(textbufferptr,80);
      var bgbuffer   = uint_carray_to_array(bgbufferptr,80);
      var fgbuffer   = uint_carray_to_array(fgbufferptr,80);

      var current_line = textmatrix_getline_txt(cy);
      if(buffer_str != current_line) {

        for(var cx=0;cx<80;cx++) {
          textmatrix_setpos(cx,cy,textbuffer[cx],bgbuffer[cx],fgbuffer[cx]);
        }
        textmatrix_redraw_line(cy);
      }
    }

  }
  
    

  var buffer = Module._malloc(1024);
  function on_recv() {
    var len = Module.ccall('webssh2_read','number',['number','number'],[buffer,1024]);
    if(len > 0) {
      Module.ccall('webvterm_recv',null,['number','number'],[buffer,len]);
      redraw();
    }
  }


</script>


<!--Pulling Awesome Font -->
<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css" rel="stylesheet">
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
<link href="login.css" rel="stylesheet">
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>

<div class="container" id="logindisplay">
    <div class="row">
        <div class="col-md-offset-5 col-md-3">
            <div class="form-login">
            <h4>Connect</h4>
            <div class="row">
              <div class="col-md-8">
                <input type="text" id="serverad" class="form-control input-sm chat-input" placeholder="server" tabindex=1 />
              </div>
              <div class="col-md-4 col-md-offset-0">
                <input type="text" id="port" class="form-control input-sm chat-input" placeholder="22" value="22" />
              </div>
            </div>
            </br>
            <input type="text" id="username" class="form-control input-sm chat-input" placeholder="username" tabindex=2 />
            <input type="password" id="password" class="form-control input-sm chat-input" placeholder="password" tabindex=3 onkeydown="if (event.keyCode == 13) do_connect();" />
            </br>
            <div class="wrapper">
            <span class="group-btn">     
                <a href="#" onclick="do_connect()" class="btn btn-primary btn-md">login <i class="fa fa-sign-in"></i></a>
            </span>
            </div>
            </div>
        
        </div>
    </div>
</div>
  <div style="display: inline; font-family: monospace; white-space: pre; margin 1em 0;" id='tml'></div>

</body>
</html>
